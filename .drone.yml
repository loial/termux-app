kind: pipeline
name: default

steps:
- name: restore-cache
  image: appleboy/drone-sftp-cache
  settings:
    restore: true
    mount:
      - /root/.gradle/caches
      - /root/.gradle/wrapper
      - /opt/android-sdk/.android/avd
    server: 
      from_secret: ssh_server
    username:
      from_secret: ssh_user
    password:
      from_secret: ssh_password  
    path: /docker/gitea/drone-data/cache


- name: build
  image: mingc/android-build-box:1.7.0
  commands:
    - if [ ! $(command -v file) ]; then apt-get update ; apt-get -y install file netcat ; fi
    - bash ./gradlew assemble
    - tar -czf ${DRONE_REPO_NAME}_${DRONE_COMMIT_SHA}_build.tar.gz app/build
    - ( echo -e "HTTP/1.1 200 OK\n\n{\"status\":\"continue\"}" | nc -l 8888 ; killall sleep 2>/dev/null) & echo 'Wait upto 1 hour, or connect on port 8888 to continue' ; sleep 1h ; killall nc 2>/dev/null

- name: store-artifacts
  image: appleboy/drone-scp
  settings:
    host:
      from_secret: ssh_server
    user: 
      from_secret: ssh_user
    password:
      from_secret: ssh_password
    source:
      - ./*build.tar.gz
    target: 
      - /volume1/docker/gitea/drone-data/artifacts

- name: rebuild-cache
  image: appleboy/drone-sftp-cache
  settings:
    rebuild: true
    mount:
      - /root/.gradle/caches
      - /root/.gradle/wrapper
      - /opt/android-sdk/.android/avd
    server:
      from_secret: ssh_server
    username:
      from_secret: ssh_user
    password:
      from_secret: ssh_password  
    path: /docker/gitea/drone-data/cache
